name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref/branch yang akan di-deploy
        required: true
        default: main
      run_migrations:
        description: Jalankan migration saat deploy
        required: true
        type: boolean
        default: true
      maintenance_mode:
        description: Aktifkan maintenance mode saat deploy
        required: true
        type: boolean
        default: true

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Validate deploy credentials
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          set -euo pipefail

          [ -n "${DEPLOY_HOST:-}" ] || { echo "Secret DEPLOY_HOST belum diisi."; exit 1; }
          [ -n "${DEPLOY_PORT:-}" ] || { echo "Secret DEPLOY_PORT belum diisi."; exit 1; }
          [ -n "${DEPLOY_USER:-}" ] || { echo "Secret DEPLOY_USER belum diisi."; exit 1; }
          if [ -z "${DEPLOY_SSH_KEY:-}" ] && [ -z "${DEPLOY_PASSWORD:-}" ]; then
            echo "Isi minimal salah satu: DEPLOY_SSH_KEY atau DEPLOY_PASSWORD."
            exit 1
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          APP_PATH: ${{ vars.DEPLOY_PATH }}
          PHP_BIN: ${{ vars.DEPLOY_PHP_BIN }}
          COMPOSER_BIN: ${{ vars.DEPLOY_COMPOSER_BIN }}
          NODE_BIN: ${{ vars.DEPLOY_NODE_BIN }}
          NPM_BIN: ${{ vars.DEPLOY_NPM_BIN }}
          BUILD_FRONTEND: ${{ vars.DEPLOY_BUILD_FRONTEND }}
          REPO_URL: ${{ vars.DEPLOY_REPO_URL }}
          DEPLOY_REF: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref_name }}
          RUN_MIGRATIONS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_migrations || 'true' }}
          MAINTENANCE_MODE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.maintenance_mode || 'true' }}
          GIT_REPOSITORY: ${{ github.repository }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          passphrase: ${{ secrets.DEPLOY_SSH_PASSPHRASE }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          timeout: 180s
          envs: APP_PATH,PHP_BIN,COMPOSER_BIN,NODE_BIN,NPM_BIN,BUILD_FRONTEND,REPO_URL,DEPLOY_REF,RUN_MIGRATIONS,MAINTENANCE_MODE,GIT_REPOSITORY
          command_timeout: 45m
          script_stop: true
          script: |
            set -euo pipefail

            APP_PATH="${APP_PATH:-$HOME/domains/daratlaut.com/public_html/laundry}"
            PHP_BIN="${PHP_BIN:-php}"
            COMPOSER_BIN="${COMPOSER_BIN:-composer}"
            NODE_BIN="${NODE_BIN:-node}"
            NPM_BIN="${NPM_BIN:-npm}"
            BUILD_FRONTEND="$(echo "${BUILD_FRONTEND:-true}" | tr '[:upper:]' '[:lower:]')"
            REPO_URL="${REPO_URL:-https://github.com/${GIT_REPOSITORY}.git}"
            DEPLOY_REF="${DEPLOY_REF:-main}"
            RUN_MIGRATIONS="$(echo "${RUN_MIGRATIONS:-true}" | tr '[:upper:]' '[:lower:]')"
            MAINTENANCE_MODE="$(echo "${MAINTENANCE_MODE:-true}" | tr '[:upper:]' '[:lower:]')"

            if [[ "$APP_PATH" == ~* ]]; then
              APP_PATH="${APP_PATH/#\~/$HOME}"
            fi

            echo "Deploy path: ${APP_PATH}"
            echo "Deploy ref : ${DEPLOY_REF}"

            if [ ! -d "$APP_PATH/.git" ]; then
              echo "Initial clone..."
              git clone "$REPO_URL" "$APP_PATH"
            fi

            cd "$APP_PATH"
            git fetch --all --prune
            git checkout "$DEPLOY_REF"
            git pull --ff-only origin "$DEPLOY_REF"

            if ! command -v "$COMPOSER_BIN" >/dev/null 2>&1; then
              echo "Composer tidak ditemukan. Set DEPLOY_COMPOSER_BIN di GitHub Variables."
              exit 1
            fi

            if ! command -v "$PHP_BIN" >/dev/null 2>&1; then
              echo "PHP binary tidak ditemukan. Set DEPLOY_PHP_BIN di GitHub Variables."
              exit 1
            fi

            if [ -f "$APP_PATH/package.json" ] && [ "$BUILD_FRONTEND" = "true" ]; then
              NODE_FOUND=""
              if command -v "$NODE_BIN" >/dev/null 2>&1; then
                NODE_FOUND="$(command -v "$NODE_BIN")"
              elif [ -x "$NODE_BIN" ]; then
                NODE_FOUND="$NODE_BIN"
              fi

              if [ -z "$NODE_FOUND" ]; then
                for CANDIDATE in \
                  node \
                  /usr/local/bin/node \
                  /usr/bin/node \
                  /opt/alt/alt-nodejs20/root/usr/bin/node \
                  /opt/alt/alt-nodejs18/root/usr/bin/node \
                  /opt/alt/alt-nodejs16/root/usr/bin/node \
                  "$HOME/.local/bin/node"
                do
                  if [ -x "$CANDIDATE" ]; then
                    NODE_FOUND="$CANDIDATE"
                    break
                  fi
                done
              fi

              if [ -z "$NODE_FOUND" ]; then
                echo "Node.js tidak ditemukan."
                echo "Set DEPLOY_NODE_BIN/DEPLOY_NPM_BIN ke path binary server, atau set DEPLOY_BUILD_FRONTEND=false untuk skip build frontend sementara."
                exit 1
              fi

              NODE_BIN="$NODE_FOUND"

              NPM_FOUND=""
              if command -v "$NPM_BIN" >/dev/null 2>&1; then
                NPM_FOUND="$(command -v "$NPM_BIN")"
              elif [ -x "$NPM_BIN" ]; then
                NPM_FOUND="$NPM_BIN"
              fi

              if [ -z "$NPM_FOUND" ]; then
                for CANDIDATE in \
                  npm \
                  /usr/local/bin/npm \
                  /usr/bin/npm \
                  /opt/alt/alt-nodejs20/root/usr/bin/npm \
                  /opt/alt/alt-nodejs18/root/usr/bin/npm \
                  /opt/alt/alt-nodejs16/root/usr/bin/npm \
                  "$(dirname "$NODE_BIN")/npm"
                do
                  if [ -x "$CANDIDATE" ]; then
                    NPM_FOUND="$CANDIDATE"
                    break
                  fi
                done
              fi

              if [ -z "$NPM_FOUND" ]; then
                echo "npm tidak ditemukan."
                echo "Set DEPLOY_NPM_BIN ke path npm di server, atau set DEPLOY_BUILD_FRONTEND=false untuk skip build frontend sementara."
                exit 1
              fi

              NPM_BIN="$NPM_FOUND"
              echo "Node binary: $NODE_BIN"
              echo "Npm binary : $NPM_BIN"
            fi

            NEED_UP=0
            cleanup() {
              if [ "$NEED_UP" -eq 1 ]; then
                "$PHP_BIN" artisan up || true
              fi
            }
            trap cleanup EXIT

            if [ "$MAINTENANCE_MODE" = "true" ]; then
              "$PHP_BIN" artisan down || true
              NEED_UP=1
            fi

            "$COMPOSER_BIN" install --no-dev --optimize-autoloader --no-interaction --prefer-dist

            if [ -f "$APP_PATH/package.json" ] && [ "$BUILD_FRONTEND" = "true" ]; then
              export NODE_ENV=development
              "$NPM_BIN" ci --no-audit --no-fund
              "$NPM_BIN" run build
            elif [ -f "$APP_PATH/package.json" ]; then
              echo "DEPLOY_BUILD_FRONTEND=false -> skip npm build."
            fi

            if [ -f "$APP_PATH/.env" ]; then
              "$PHP_BIN" artisan storage:link || true

              if [ "$RUN_MIGRATIONS" = "true" ]; then
                "$PHP_BIN" artisan migrate --force
              fi

              "$PHP_BIN" artisan optimize:clear
              "$PHP_BIN" artisan config:cache
              "$PHP_BIN" artisan route:cache
              "$PHP_BIN" artisan view:cache
              "$PHP_BIN" artisan queue:restart || true
            else
              echo "File .env belum ada di server. Deploy kode selesai, konfigurasi aplikasi belum dijalankan."
            fi

            if [ "$MAINTENANCE_MODE" = "true" ]; then
              "$PHP_BIN" artisan up || true
              NEED_UP=0
            fi

            echo "Deploy selesai."
